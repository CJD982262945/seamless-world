### 场景主要类
- Match下的Scene, 路径Match\Scene.go

```go
// Scene 场景
type Scene struct {
entity.Entity

avgMMR uint32

objs map[uint64]IMatcher

mapid         uint32
skybox        uint32
haveai        int
isSingleMatch bool
teamType      uint8
status        int
createTime    int64
}
```
- Room 下的Scene, 路径Room\Space.go
```go

// SceneItem 场景中的道具
type SceneItem struct {
	id         uint64
	pos        linmath.Vector3
	dir        linmath.Vector3
	itemid     uint32
	item       *Item
	haveobjs   map[uint32]*Item
	cangettime int64
}

// Scene 游戏局结构,主要存放这些数据
type Scene struct {
	space.Space
	status          int                   //当前状态，
	createStamp     int64                 //创建时间
	mapdata         excel.MapsData        //地图数据

	...
	mapitem  map[uint64]*SceneItem
	mapindex uint32
  ...
	aiMgr                 *RoomAIMgr
	members               map[uint64]bool
	closetime             int64
	...
	teamMgr *st.SpaceTeams // 场景中所有队伍

	minLoadTime time.Duration
	maxLoadTime time.Duration

	maploadSuccess bool

	refreshItemInst *MapItemRate

	doorMgr      *SpaceDoorMgr

	GameID       uint64
	spaceType uint32         // 1(组队)，2(非组队), 同 protoMsg.SummonAINotify.SceneType 的定义
	...

	lastLoopTime int64 // Loop调用优化
}
```
### 注册场景类型并创建
	srv.RegProtoType("Space", &Scene{})
	可以把Space和Scene理解成是等价的，createentityAll("Space",...)的时候也就创建了Scene

### Match上场景
- 路径 Match\Scene.go

```go
func (scene *Scene) Init(initParam interface{}) {
scene.RegMsgProc(&SceneMsgProc{scene: scene})

scene.status = common.SpaceStatusInit
scene.createTime = time.Now().Unix()

...

match := entity.GetEntityProxy(mgrName)
if match == nil {
	log.Error("获取匹配管理器失败 ", initParam, scene)
	return
}

e := GetSrvInst().GetEntity(match.EntityID)
if e == nil {
	log.Error("获取匹配管理器为空 ", match)
	return
}

mgr := e.(*MatchMgr)
mgr.pushScene(scene)
}

func (mgr *MatchMgr) pushScene(scene *Scene) {
	select {
	case mgr.scenesC <- scene:
	default:
		seelog.Error("match manager had been block ", scene)
		return
	}
}

// Loop 逻辑帧
func (mgr *MatchMgr) Loop() {

	mgr.Timer.Loop()
	for _, l := range mgr.mapID2WsList {
		for e := l.Front(); e != nil; e = e.Next() {
			ws := e.Value.(IWaitingScene)

			if ws.IsWaitSceneInit() {
				continue
			}

			if ws.IsNeedRemove() {
				l.Remove(e)
				mgr.UnregTimerByObj(ws)
				continue
			}

			if ws.IsReady() {
				mgr.expendTime = ws.GetExpendTime()
				ws.Go()
			} else {
				ws.OffsetIncrement()
			}
		}
	}

	for {
		select {
		case s := <-mgr.scenesC:
			mgr.initScene(s)
		default:
			return
		}
	}
}


func (mgr *MatchMgr) initScene(scene *Scene) {
	for _, l := range mgr.mapID2WsList {
		for e := l.Front(); e != nil; e = e.Next() {
			ws := e.Value.(*WaitingScene)
			if ws.GetSpaceID() != scene.GetID() {
				continue
			}

			l.Remove(e)
			mgr.initSceneWithWaitingScene(scene, ws)
			return
		} // for e
	} // for _, l
}

//下面几个函数介绍mapID2WsList的赋值
func (proc *MatchMgrMsgProc) RPC_EnterSoloQueue(srvID, entityID uint64, mapid, mmr, rank uint32, name string, role uint32, dbid uint64) {
	...

	ws := proc.mgr.getWaitingScene(member)
	ws.Add(member)
	...

}

func (mgr *MatchMgr) newWaitingScene(mapid uint32, singleMatch bool, teamType uint8, rating float32, offsetRating float32, timeInterval int64, offsetIncrement float32) IWaitingScene {
	...
	ws := NewWaitingScene(min, max, minWait, maxWait, mapid, singleMatch, teamType, rating, offsetRating, timeInterval, offsetIncrement)
	l, ok := mgr.mapID2WsList[mapid]
	if !ok {
		l = list.New()
		mgr.mapID2WsList[mapid] = l
	}
	l.PushBack(ws)

	...
	return ws
}

```

### Room上场景
- 路径在src\Room\Space.go

	room上Space创建好之后， 会调用OnMapLoadSucceed

	```go
	func (tb *Scene) OnMapLoadSucceed() {

		...

		GetRefreshItemMgr(tb).InitSceneItem()

		...

		// 通知Match, Space创建完成, 新的匹配流程
		if err := tb.RPC(common.ServerTypeMatch, "RoomSpaceInited"); err != nil {
			log.Error(err, tb)
		}

		...

		// 在客户端进出生岛之前,将组队信息发送给客户端
		tb.teamMgr.InitRoomTeamInfo()InitRoomTeamInfo()
	}
	```
