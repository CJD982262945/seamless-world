## Entity属性定义

实体可以没有属性。

以下几种情况，需要定义实体属性

  - 分布式实体需要同步数据
  - 实体数据需要持久化


TimeFire中，在TimeFire/server/res/entitydef目录下的json文件为各实体的属性定义。

目前有属性的实体有以下：
  - Player
  - Item
  - AI
  - Vehicle


## 自动生成属性操作方法

执行TimeFire/server/res/entitydef/generator.exe，它根据实体属性定义json文件，可以自动生成操作实体属性的go文件。

生成位置：TimeFire/server/src/entitydef目录下

工具generator.exe的源代码位于：src/generator

生成的go文件有何用处，看下面代码：

```go
type RoomUser struct {
	entitydef.PlayerDef
	// ...(略)...
}
```

这样，就使RoomUser实体类具备操作各种属性的方法。

主要3类方法：

  - SetXXX()
  - GetXXX()
  - XXXDirty()

这样避免手工繁琐的写这些属性方法实现。


## 实体属性定义加载

zeus/entity/EntityDef.go在程序启动时，根据TimeFire/server/res/entitydef/* .json文件，加载实体属性定义。

```go
func init() {
	initDefs()
  // ...(略)...
}
func initDefs() {
	inst = &Defs{
		defs: make(map[string]*Def),
	}
	inst.Init()
}
func (defs *Defs) Init() {
	err := filepath.Walk("../res/entitydef", func(path string, f os.FileInfo, err error) error {
		// ...(略)...
		if strings.HasSuffix(path, ".json") {
			raw, err := ioutil.ReadFile(path)
			// ...(略)...
			defs.defs[jsonInfo["name"].(string)] = def
		}

		return nil
	})
  // ...(略)...
}
```


## 实体创建后，初始化属性

```go
func (e *Entity) InitProp(def *Def) {
	if def == nil {
		return
	}

	e.def = def

	for _, p := range e.def.Props {

		isAdd := false

		for _, s := range p.InterestSrvs {
			if s == iserver.GetSrvInst().GetSrvType() {
				isAdd = true
				break
			}
		}

		if isAdd {
			e.addProp(p)
		}
	}

	// ...(略)...
}
```
代码分析：
  - def可以为nil。即实体可以没有属性
  - if s == iserver.GetSrvInst().GetSrvType() {，只创建本服务类型感兴趣的属性

## 实体属性定义json文件介绍

##### 五大字段：

字段        | 说明
------------| ------------------------------
name        | 实体名（entityType）
props       | 属性定义列表
server      | 某服务类型服务感兴趣的属性列表
client      | 客户端AOI内关注的属性列表（就是说，除了发送给自己也发送给自己周围的人的属性）
mrole       | 主角自己关注的属性列表（就是说，只发送给自己的属性）

##### props字段

props字段定义了实体的所有属性。

一个属性定义，有以下字段：

字段        | 说明
------------| ------------------------------
type        | 该属性类型
save        | 该属性是否持久化。可以不填写。除了save=0，其他情况都需要持久化
sync        | 该属性是否需要同步属性。可以不填写。除了sync=0，其他情况都需要同步
desc        | 该属性描述

##### server字段

某服务类型服务感兴趣的属性罗列在此。如，

```json
"server" : {
    "12" : {
      "desc" : "Room" ,
      "props" : [
          "baseid",
          "num",
          "reducedam"
      ]
    },
    "11" : {
      "desc" : "Lobby" ,
      "props" : [
          "same field"
      ]
    }
}
```

11表示Lobby服务；12表示Room服务


## 实体属性定义后，Zeus做了什么

  - 实体属性定义了属性是否存取数据库
  - 实体属性定义了属性是否同步对它给感兴趣的服务、或是客户端

Zeus层Entity系统根据这些定义，在背后自动完成相关功能。

Server层要做的就是使用、改变这些属性。至于如何同步数据、如何持久化数据，交给Zeus层完成。


## 关于Zeus层，属性如何同步、如何持久化

后续章节介绍
