## zeus/serverMgr

TimeFire 通过 zeus/serverMgr 包实现 `服务发现`

相关代码：

```tree
zeus
├─serverMgr
│      balancer.go
│      serverMgr.go
│      updater.go
```

```tree
zeus
├─dbservice
│      serverutil.go
```

文件名       | 说明
------------ |---------------------
balancer.go  | 负载均衡器。功能：轮询获取服务器；获取最新的服务器列表
serverMgr.go | 服务器管理器。功能：注册服务器自身信息；验证连接有效性；包含负载均衡器、负载更新器
updater.go   | 负载更新器。功能：定期更新服务器自身信息
serverutil.go| 保存服务器信息的辅助工具类


## 实现原理

1. 服务进程启动时，向SingletonRedis (Redis)注册自身信息，**带超时时间戳**
1. 定时更新自身信息
1. 服务进程关闭时，向SingletonRedis (Redis)注销自身信息
1. 服务进程可以向SingletonRedis (Redis)查询某类型服务列表、进而获取某个服务节点

以上，简单的实现了`服务发现`逻辑


## 超时时间

服务进程定时更新自身信息（`5秒`更新一次）

若超过`60秒`没有向SingletonRedis (Redis)更新操作，则视为该进程已经失效。


## 服务自身信息之`负载指标`

#### GetLoad 接口

通过重载GetLoad接口，来实现获取负载值。
```go
type iUpdateCtrl interface {
	GetLoad() int
}
```

目前的默认实现为取 max(CPU使用率, 内存使用率)：
```go
func (srv *Server) GetLoad() int {
	var c int
	var vm int

	if loads, err := cpu.Percent(0, false); err == nil {
		if len(loads) > 0 {
			c = int(loads[0])
		}
	} else {
		log.Error(err)
		c = 100
	}

	if memorys, err := mem.VirtualMemory(); err == nil {
		vm = int(memorys.UsedPercent)
	} else {
		log.Error(err)
		vm = 100
	}

	if c > vm {
		return c
	}

	return vm
}
```


#### Config.MaxLoad

`负载指标`阀值由 TimeFire/server/res/config/server.json 中的 Config.MaxLoad 字段配置


## 几个API

API | 说明
----|------
serverMgr.GetServerMgr().GetServerList() | 获取当前所有服务器列表
serverMgr.GetServerMgr().GetServerByType(iserver.ServerTypeXXX) | 获取某类型的一个有效服务器。（轮询方式）


## 源代码分析

略（几个文件内容很少，请自行阅读）
