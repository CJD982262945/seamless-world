## 使用范围

只在Zeus层


## 消息号范围

消息号范围：[1, 11000)

*友情提示：消息号范围详细介绍在 [Protobuf协议](4-8.Zeus网络封装层介绍之Protobuf协议.md) 中介绍*


## 使用方法

#### 1.定义消息号

`zeus/msgdef/MessageConst.go` 中定义

#### 2.struct消息定义

需要实现下列接口：

```go
type IMsg interface {
	MarshalTo(data []byte) (n int, err error)
	Unmarshal(data []byte) error
	Size() (n int)
	Name() string
}
```
例子：
```go
// ClientVertifyReq 验证消息
type ClientVertifyReq struct {
	// Source: 消息来源, 分客户端或者服务器(ClientMSG/服务器类型)
	Source uint8 //data[0]
	// UID: 玩家UID或者服务器ID
	UID uint64 //data[1:9]
	// Token: 客户端登录时需要携带Token
	Token string //data[9:41]
}

// Name 消息名
func (msg *ClientVertifyReq) Name() string {
	return "ClientVertifyReq"
}

// MarshalTo 序列化
func (msg *ClientVertifyReq) MarshalTo(data []byte) (n int, err error) {
	bw := common.NewByteStream(data)
	return msg.Size(), bw.Marshal(msg)
}

// Unmarshal 反序列化
func (msg *ClientVertifyReq) Unmarshal(data []byte) error {

	sw := common.NewByteStream(data)
	msg.Source, _ = sw.ReadByte()
	msg.UID, _ = sw.ReadUInt64()
	msg.Token, _ = sw.ReadStr()

	return nil
}

// Size 获取长度
func (msg *ClientVertifyReq) Size() (n int) {
	return 1 + 8 + len(msg.Token) + 2
}
```

#### 3.消息注册

`zeus/msgdef/MsgDef_bytes.go` 中注册

```go
func (def *MsgDef) InitBytesMsg() {
	def.RegMsg(ClientVertifyReqMsgID, "ClientVertifyReq", new(ClientVertifyReq))
	// ...(略)...
}
```

#### 4.实现回调函数

回调函数命名有规则，**必须以MsgProc_开头**。例如：

```go
func (p *GatewaySrvMsgProc) MsgProc_SessVertified(content interface{}) {

	uid := content.(uint64)
	GetUserMgr().login(uid)
}
```

#### 5.注册回调函数

实现回调函数的，必须注册。使用 `IMsgHandlers.RegMsgProc` 函数，例如：

```go
func (srv *GatewaySrv) Init() error {
	// ...(略)...
	srv.clientSrv.RegMsgProc(&GatewaySrvMsgProc{})
	// ...(略)...
}
```

#### 6.S->Gateway->C回发struct协议

暂时没有找到简单的接口。

可以依附于实体回发struct协议。

使用实体的 Post、RPC接口。

## 哪些服务支持struct协议


即哪些服务上做了 消息注册(InitBytesMsg) 的调用

使用zeus/sess提供TCP服务的，都注册了struct协议。即Gateway、Lobby、Room、Match、Center。代码分析如下：

```go
func GetMsgDef() *MsgDef {

	if msgDefInst == nil {
		msgDefInst = &MsgDef{
			make(map[uint16]*MsgInfo),
			make(map[string]*MsgInfo),
		}
		msgDefInst.Init()
	}

	return msgDefInst
}

func (def *MsgDef) Init() {
	def.InitBytesMsg()
}

func readARQMsgForward(conn net.Conn) (msgdef.IMsg, int, []byte, error) {

	// ...(略)...

	msgID := GetMsgID(msgData)
	if msgdef.GetMsgDef().IsMsgExist(msgID) {
		msg, err := DecodeMsg(compressFlag, msgData)
		return msg, 0, nil, err
	}

	// ...(略)...

}
```

代码分析：
  - GetMsgDef()，单例实例化时，调用InitBytesMsg()，注册了struct协议
  - readARQMsgForward 在接收消息协程中，用于读取net.Conn中的消息。该函数内调用了GetMsgDef()单例。

因此，Gateway、Lobby、Room、Match、Center都支持struct协议。只要提供其回调函数即可
